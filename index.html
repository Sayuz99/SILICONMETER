<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SILICONMETER - Real-time Price Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for JSX compilation in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Load Recharts for charting -->
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.0/umd/Recharts.min.js"></script> 

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase modules globally for the Babel script to use
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            onSnapshot,
            collection,
            query,
            limit,
            orderBy,
            setLogLevel
        };
        // Set log level to debug for easier troubleshooting
        window.firebase.setLogLevel('debug');
    </script>

    <style>
        /* Define custom styles for the dark theme and global font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background-color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div id="root">
        <!-- React App will be rendered here -->
    </div>

    <script type="text/babel">
        // Ensure React is available (loaded via CDN)
        const { useState, useEffect, useCallback, useMemo } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = Recharts;

        // --- GLOBAL SETUP (Must use provided global variables) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = null;
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Failed to parse __firebase_config:", e);
        }

        // Firestore paths
        const FIRESTORE_COLLECTION_PATH = `/artifacts/${appId}/public/data/products`;
        const FIRESTORE_DOC_ID = 'siliconmeter_data'; // We'll store all data in a single document for simplicity

        // Helper components for icons (using Lucide)
        const LucideIcon = ({ name, className = 'w-5 h-5', ...props }) => {
            const iconElement = lucide.createIcons()[name];
            if (!iconElement) return null;
            return (
                <div 
                    dangerouslySetInnerHTML={{ __html: iconElement }} 
                    className={className} 
                    {...props} 
                />
            );
        };
        
        // --- CUSTOM HOOKS ---
        
        // 1. Firebase/Auth Hook
        const useFirebaseAuth = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                if (!firebaseConfig || !Object.keys(firebaseConfig).length) {
                    console.error("Firebase config is missing or invalid.");
                    setIsAuthReady(true); // Treat as ready but unauthenticated
                    return;
                }

                try {
                    const app = firebase.initializeApp(firebaseConfig);
                    const firestore = firebase.getFirestore(app);
                    const authentication = firebase.getAuth(app);
                    
                    setDb(firestore);
                    setAuth(authentication);

                    const unsubscribe = firebase.onAuthStateChanged(authentication, async (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setIsAuthReady(true);
                            console.log("User authenticated. UID:", user.uid);
                        } else {
                            // Initial sign-in logic if not already signed in
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await firebase.signInWithCustomToken(authentication, __initial_auth_token);
                                } else {
                                    await firebase.signInAnonymously(authentication);
                                }
                            } catch (error) {
                                console.error("Firebase authentication failed:", error);
                            }
                        }
                    });

                    // Cleanup auth listener on component unmount
                    return () => unsubscribe();

                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    setIsAuthReady(true);
                }
            }, []);

            return { db, userId, isAuthReady };
        };

        // 2. Firestore Data Hook
        const useFirestoreData = (db, isAuthReady) => {
            const [liveData, setLiveData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!db || !isAuthReady) {
                    if (isAuthReady) setLoading(false);
                    return;
                }

                const docRef = firebase.doc(db, FIRESTORE_COLLECTION_PATH, FIRESTORE_DOC_ID);
                console.log(`Setting up snapshot listener on: ${FIRESTORE_COLLECTION_PATH}/${FIRESTORE_DOC_ID}`);

                const unsubscribe = firebase.onSnapshot(docRef, 
                    (docSnapshot) => {
                        if (docSnapshot.exists()) {
                            const data = docSnapshot.data();
                            setLiveData(data);
                            console.log("Firestore Data Updated:", data);
                        } else {
                            // If the document doesn't exist, we use the fallback/mock data
                            console.warn("Firestore document not found. Using mock data structure.");
                            setLiveData(MOCK_DATA);
                        }
                        setLoading(false);
                        setError(null);
                    }, 
                    (e) => {
                        console.error("Error fetching Firestore data:", e);
                        setError("Failed to load data from database.");
                        setLoading(false);
                        setLiveData(MOCK_DATA); // Fallback to mock data on error
                    }
                );

                // Cleanup listener on component unmount
                return () => unsubscribe();

            }, [db, isAuthReady]);

            return { liveData, loading, error };
        };
        
        // --- MOCK DATA (Fallback if Firestore connection fails or document doesn't exist) ---
        // This structure mirrors the data.json file previously provided.
        const MOCK_DATA = {
          "last_updated": "2025-11-25T12:26:54.770616",
          "products": [
            {
              "id": "dram-001",
              "name": "Corsair Vengeance 32GB DDR5",
              "type": "DDR5",
              "url": "https://amazon.com/example-product-link",
              "selector": "#corePriceDisplay_desktop_feature_div .a-price-whole",
              "current_price": 110.76,
              "change_24h": -4.76,
              "sentiment": "buy",
              "stock_status": "In Stock",
              "history": [
                { "date": "2025-11-20", "price": 135.0 },
                { "date": "2025-11-21", "price": 138.5 },
                { "date": "2025-11-22", "price": 140.0 },
                { "date": "2025-11-23", "price": 142.5 },
                { "date": "2025-11-24", "price": 122.65 },
                { "date": "2025-11-25", "price": 110.76 }
              ]
            },
            {
              "id": "gpu-001",
              "name": "NVIDIA RTX 5080 Ti Founders",
              "type": "Triple-GPU",
              "url": "https://newegg.com/example-gpu",
              "selector": ".priceView-hero-price span",
              "current_price": 1948.75,
              "change_24h": 3.48,
              "sentiment": "hold",
              "stock_status": "Low Stock",
              "history": [
                { "date": "2025-11-20", "price": 1850.0 },
                { "date": "2025-11-21", "price": 1840.0 },
                { "date": "2025-11-22", "price": 1820.0 },
                { "date": "2025-11-23", "price": 1810.0 },
                { "date": "2025-11-24", "price": 1984.71 },
                { "date": "2025-11-25", "price": 1948.75 }
              ]
            },
            {
              "id": "cpu-001",
              "name": "Intel Core i11-14900K",
              "type": "CPU",
              "url": "https://bestbuy.com/example-cpu",
              "selector": ".price-value",
              "current_price": 612.33,
              "change_24h": -8.11,
              "sentiment": "buy",
              "stock_status": "In Stock",
              "history": [
                { "date": "2025-11-20", "price": 680.0 },
                { "date": "2025-11-21", "price": 675.0 },
                { "date": "2025-11-22", "price": 660.0 },
                { "date": "2025-11-23", "price": 650.0 },
                { "date": "2025-11-24", "price": 666.22 },
                { "date": "2025-11-25", "price": 612.33 }
              ]
            }
          ]
        };

        // --- CHART COMPONENT ---
        const PriceChart = ({ history }) => {
            const data = history.map(item => ({
                date: new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                price: item.price
            })).slice(-7); // Show last 7 days

            return (
                <div className="h-64 w-full p-4">
                    <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={data} margin={{ top: 5, right: 0, left: -20, bottom: 5 }}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                            <XAxis dataKey="date" stroke="#9ca3af" tick={{ fontSize: 10 }} />
                            <YAxis 
                                stroke="#9ca3af" 
                                tick={{ fontSize: 10 }} 
                                domain={['auto', 'auto']}
                                tickFormatter={(value) => `$${Math.round(value)}`}
                            />
                            <Tooltip 
                                contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #4b5563', borderRadius: '4px' }}
                                labelStyle={{ color: '#ffffff' }}
                                formatter={(value) => [`$${value.toFixed(2)}`, 'Price']}
                            />
                            <Line 
                                type="monotone" 
                                dataKey="price" 
                                stroke="#a78bfa" 
                                strokeWidth={2} 
                                dot={false} 
                                activeDot={{ r: 6, fill: '#8b5cf6' }} 
                            />
                        </LineChart>
                    </ResponsiveContainer>
                </div>
            );
        };

        // --- PRODUCT CARD COMPONENT ---
        const ProductCard = ({ product }) => {
            const isNegative = product.change_24h < 0;
            const changeColor = isNegative ? 'text-red-400' : 'text-green-400';
            const arrowIcon = isNegative ? 'ArrowDown' : 'ArrowUp';
            const sentimentClass = useMemo(() => {
                switch (product.sentiment.toLowerCase()) {
                    case 'panic': return 'bg-red-900/50 text-red-300';
                    case 'buy': return 'bg-green-900/50 text-green-300';
                    case 'hold': 
                    default: return 'bg-yellow-900/50 text-yellow-300';
                }
            }, [product.sentiment]);
            
            const stockStatusClass = product.stock_status.includes('Low') || product.stock_status.includes('Out') ? 'text-red-400' : 'text-green-400';

            return (
                <div className="bg-gray-800 rounded-xl shadow-2xl p-6 transition transform hover:scale-[1.01] duration-300 border border-gray-700">
                    <div className="flex justify-between items-start">
                        <div>
                            <span className="text-xs font-medium text-indigo-400 uppercase tracking-widest">{product.type}</span>
                            <h2 className="text-2xl font-bold mt-1 text-white">{product.name}</h2>
                        </div>
                        <span className={`text-sm font-semibold px-3 py-1 rounded-full ${sentimentClass} uppercase`}>
                            {product.sentiment}
                        </span>
                    </div>

                    <div className="mt-4 flex items-baseline">
                        <p className="text-4xl font-extrabold text-indigo-300">
                            ${product.current_price.toFixed(2)}
                        </p>
                        <span className={`ml-3 text-lg font-semibold flex items-center ${changeColor}`}>
                            <LucideIcon name={arrowIcon} className="w-5 h-5 mr-1" />
                            {Math.abs(product.change_24h).toFixed(2)}%
                        </span>
                    </div>

                    <div className="mt-2 text-sm text-zinc-400">
                        <span className="font-semibold">24h Change: </span>
                        <span className={changeColor}>{product.change_24h > 0 ? '+' : ''}{product.change_24h.toFixed(2)}%</span>
                        <span className="ml-4 font-semibold">Stock: </span>
                        <span className={stockStatusClass}>{product.stock_status}</span>
                    </div>

                    {product.history && product.history.length > 0 && (
                        <PriceChart history={product.history} />
                    )}

                    <a href={product.url} target="_blank" rel="noopener noreferrer" className="mt-4 block w-full text-center bg-indigo-600 text-white font-bold py-2 rounded-lg shadow-md hover:bg-indigo-500 transition duration-150">
                        View Product Price
                    </a>
                </div>
            );
        };

        // --- MAIN APPLICATION COMPONENT ---
        const App = () => {
            const { db, userId, isAuthReady } = useFirebaseAuth();
            const { liveData, loading, error } = useFirestoreData(db, isAuthReady);

            // Ticker items for the marquee
            const tickerItems = useMemo(() => [
                '‚ö†Ô∏è Warning: Global Silicon Shortage Expected to Last Through 2026.',
                'üìà GPU spot prices up 3.48% in 24 hours.',
                'üìâ DRAM (32GB) down 4.76% - BUY signal active.',
                'üî• CPU Inventory Critical at Major Distributors.'
            ], []);

            const renderContent = () => {
                if (!isAuthReady || loading) {
                    return (
                        <div className="text-center py-20">
                            <LucideIcon name="Loader2" className="w-10 h-10 mx-auto animate-spin text-indigo-400" />
                            <p className="mt-4 text-indigo-300">
                                Authenticating and loading Silicon Market Data...
                            </p>
                            {/* Displaying UID for debugging/sharing as per instruction */}
                            <p className="mt-2 text-xs text-zinc-600">
                                User ID: {userId || 'Authenticating...'}
                            </p>
                        </div>
                    );
                }

                if (error || !liveData || !liveData.products) {
                    return (
                        <div className="text-center py-20 bg-red-900/20 border border-red-700 rounded-xl m-8">
                            <LucideIcon name="CloudOff" className="w-10 h-10 mx-auto text-red-400" />
                            <p className="mt-4 text-red-300 font-semibold">
                                Error: {error || "Data structure invalid or empty."}
                            </p>
                            <p className="text-sm text-red-400 mt-2">
                                Displaying cached mock data. Check console for Firebase logs.
                            </p>
                        </div>
                    );
                }

                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        {liveData.products.map(product => (
                            <ProductCard key={product.id} product={product} />
                        ))}
                    </div>
                );
            };

            return (
                <div className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                    
                    {/* Header with Title and User ID */}
                    <header className="py-6 border-b border-gray-700 mb-8">
                        <div className="flex justify-between items-center">
                            <h1 className="text-4xl font-extrabold text-indigo-400 tracking-tight flex items-center">
                                <LucideIcon name="Target" className="w-8 h-8 mr-3" />
                                SILICONMETER
                            </h1>
                            <div className="text-right text-sm">
                                <p className="text-zinc-400">Authenticated User</p>
                                {/* Mandatory display of full userId */}
                                <p className="text-xs text-zinc-500 break-all">{userId || 'N/A'}</p>
                            </div>
                        </div>
                        <p className="text-zinc-400 mt-2 text-lg">
                            Real-time tracking and sentiment analysis for critical PC components.
                        </p>
                    </header>

                    {/* LIVE TICKER MARQUEE */}
                    <div className="bg-gray-800 p-3 rounded-lg shadow-xl overflow-hidden mb-8 border border-gray-700">
                        <div className="flex space-x-8 animate-marquee whitespace-nowrap">
                            {/* Duplicate content to create seamless loop */}
                            {[...tickerItems, ...tickerItems].map((item, index) => (
                                <span key={index} className="text-sm font-mono text-yellow-400 uppercase tracking-wider">
                                    {item}
                                </span>
                            ))}
                        </div>
                    </div>

                    {/* MAIN CONTENT GRID */}
                    {renderContent()}

                    {/* CALL TO ACTION / INFORMATION SECTION */}
                    <div className="mt-12 p-8 bg-indigo-900/30 rounded-2xl shadow-inner border border-indigo-800">
                        <div className="flex flex-col lg:flex-row justify-between items-center">
                            <div className="mb-6 lg:mb-0 lg:w-3/4">
                                <h3 className="text-3xl font-bold text-indigo-200">
                                    Understand the Market Sentiment
                                </h3>
                                <p className="text-indigo-300 mt-2">
                                    Our proprietary **PANIC** (Sell), **BUY** (Acquire), and **HOLD** (Wait) algorithm is based on 7-day moving averages. Don't pay peak prices!
                                </p>
                            </div>
                            <div className="flex-shrink-0">
                                <button className="flex items-center bg-indigo-600 font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-indigo-500 transition text-white">
                                    <LucideIcon name="MessageCircle" className="w-5 h-5 mr-2" />
                                    Join Discussion
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* FOOTER */}
                    <footer className="border-t border-white/10 mt-12 py-8 text-center text-zinc-600 text-sm">
                        <p>Data aggregated from Global Spot Markets and Retail APIs. Displaying Firestore data or Mock data.</p>
                        <p className="mt-2">Last updated: {liveData?.last_updated ? new Date(liveData.last_updated).toLocaleString() : 'N/A'}</p>
                        <p className="mt-2">Built with ‚ù§Ô∏è for the Canvas Environment.</p>
                    </footer>
                    
                    {/* CSS for Ticker Animation */}
                    <style>{`
                        .animate-marquee {
                            animation: marquee 30s linear infinite;
                        }
                        @keyframes marquee {
                            0% { transform: translateX(0); }
                            100% { transform: translateX(-50%); }
                        }
                    `}</style>
                </div>
            );
        };

        // Render the application to the root element
        ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
